<script src="https://cdn.tailwindcss.com"></script>
<div class="min-h-screen bg-gray-50 p-4 sm:p-8">
  <div class="max-w-4xl mx-auto">

    <header class="text-center py-6 mb-8 bg-white shadow-lg rounded-xl">
      <h1 class="text-3xl sm:text-4xl font-extrabold text-indigo-700">Email Tracking Dashboard</h1>
      <p class="mt-1 text-gray-500">Test your email sending and open tracking API endpoints.</p>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

      <div class="bg-white p-6 sm:p-8 shadow-xl rounded-xl">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">1. Send Tracked Email</h2>

        <form (ngSubmit)="sendEmail()">
          <div class="mb-4">
            <label for="recipient" class="block text-sm font-medium text-gray-700 mb-1">Recipient Email</label>
            <input type="email" id="recipient" [(ngModel)]="sendForm.recipientEmail" name="recipient" required
              class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
          </div>
          <div class="mb-6">
            <label for="subject" class="block text-sm font-medium text-gray-700 mb-1">Subject</label>
            <input type="text" id="subject" [(ngModel)]="sendForm.subject" name="subject" required
              class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
          </div>
          <div class="mb-6">
            <label for="body" class="block text-sm font-medium text-gray-700 mb-1">Body Content (HTML)</label>
            <textarea id="body" [(ngModel)]="sendForm.body" name="body" required rows="4"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea>
          </div>
          <div class="mb-6 flex items-center justify-between">
            <label for="protocol" class="text-sm font-medium text-gray-700">Protocol:</label>
            <select id="protocol" [(ngModel)]="sendForm.protocol" name="protocol"
              class="w-1/2 px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
              <option value="SMTP">SMTP</option>
              <option value="MSGRAPH">MSGRAPH</option>
            </select>
          </div>

          <button type="submit" [disabled]="isSending()"
            class="w-full px-4 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 disabled:bg-indigo-400 transition duration-150 ease-in-out">
            @if (isSending()) {
            <span
              class="animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>
            Sending...
            } @else {
            Send Email with Tracking Pixel
            }
          </button>
        </form>

        @if (sendResponse()) {
        <div class="mt-6 p-4 rounded-lg text-sm"
          [ngClass]="{'bg-green-100 text-green-800 border border-green-300': sendResponse()?.status === 'SUCCESS',
                                'bg-red-100 text-red-800 border border-red-300': sendResponse()?.status !== 'SUCCESS'}">
          <p class="font-bold">{{ sendResponse()?.status }}</p>
          <p>{{ sendResponse()?.message }}</p>
          @if (sendResponse()?.messageId) {
          <p class="mt-2 break-all font-mono text-xs">Batch ID: {{ sendResponse()?.messageId }}</p>
          }
        </div>
        }
      </div>

      <div class="bg-white p-6 sm:p-8 shadow-xl rounded-xl">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">2. Check Tracking Status</h2>

        <form (ngSubmit)="checkStatus()">
          <div class="mb-4">
            <label for="trackingId" class="block text-sm font-medium text-gray-700 mb-1">Individual Tracking ID</label>
            <input type="text" id="trackingId" [(ngModel)]="statusForm.trackingId" name="trackingId" required
              class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm font-mono text-sm focus:ring-indigo-500 focus:border-indigo-500">
            <p class="text-xs text-gray-500 mt-1">Copy the full ID (Batch-Suffix-Email) from your email system logs.</p>
          </div>

          <button type="submit" [disabled]="isCheckingStatus()"
            class="w-full px-4 py-3 bg-teal-600 text-white font-semibold rounded-lg shadow-md hover:bg-teal-700 disabled:bg-teal-400 transition duration-150 ease-in-out">
            @if (isCheckingStatus()) {
            <span
              class="animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>
            Checking...
            } @else {
            Get Tracking Data
            }
          </button>
        </form>

        <div class="mt-6">
          @if (isCheckingStatus() === false && trackingData().status === 'SUCCESS') {
          <h3 class="text-xl font-semibold text-gray-700 mb-3">Tracking Record Found</h3>
          <div class="space-y-3 p-4 bg-indigo-50 rounded-lg shadow-inner">
            <p class="flex justify-between items-center"><span class="font-medium text-gray-600">Recipient:</span> <span
                class="text-indigo-800 font-mono text-sm">{{ trackingData().entity?.recipientEmail }}</span>
            </p>
            <p class="flex justify-between items-center"><span class="font-medium text-gray-600">Opens:</span> <span
                class="text-2xl font-bold text-teal-600">{{ trackingData().entity?.openCount }}</span></p>
            <p class="flex justify-between items-center"><span class="font-medium text-gray-600">Sent Time:</span>
              <span>{{ trackingService.formatTimestamp(trackingData().entity?.sentTimestamp) }}</span>
            </p>
            <p class="flex justify-between items-center"><span class="font-medium text-gray-600">Last Open:</span>
              <span>{{ trackingService.formatTimestamp(trackingData().entity?.lastOpenTimestamp) || 'N/A' }}</span>
            </p>
          </div>

          <h4 class="text-lg font-semibold text-gray-700 mt-5 mb-2 border-t pt-4">Client Details</h4>
          <dl class="text-sm space-y-1">
            <div class="flex justify-between border-b pb-1">
              <dt class="font-medium text-gray-600">IP Address:</dt>
              <dd class="font-mono text-xs">{{ trackingData().entity?.clientIpAddress || 'N/A' }}</dd>
            </div>
            <div class="flex justify-between border-b pb-1">
              <dt class="font-medium text-gray-600">Browser/Device:</dt>
              <dd>{{ trackingData().entity?.clientBrowser }} / {{ trackingData().entity?.clientDevice }}</dd>
            </div>
            <div class="flex justify-between pb-1">
              <dt class="font-medium text-gray-600">Location:</dt>
              <dd>{{ trackingData().entity?.clientCity }} ({{ trackingData().entity?.clientCountry }})</dd>
            </div>
          </dl>

          } @else if (isCheckingStatus() === false && trackingData().status === 'NOT_FOUND') {
          <div class="p-4 bg-yellow-100 rounded-lg text-yellow-800 border border-yellow-300">
            Record not found for this Tracking ID. Ensure the ID is correct and the email was sent.
          </div>
          } @else if (isCheckingStatus() === false && trackingData().status === 'ERROR') {
          <div class="p-4 bg-red-100 rounded-lg text-red-800 border border-red-300">
            <p class="font-bold">API Error:</p>
            <p>{{ trackingData().message }}</p>
          </div>
          }
        </div>
      </div>
    </div>

    <div class="bg-white p-6 sm:p-8 shadow-xl rounded-xl mt-8">
      <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2 flex justify-between items-center">
        3. Admin Tracking Dashboard
        <button (click)="loadAllTrackingData()" [disabled]="isLoadingAll()"
          class="text-sm px-3 py-1 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 disabled:opacity-50 transition duration-150">
          @if (isLoadingAll()) {
          <span
            class="animate-spin inline-block w-3 h-3 border-2 border-gray-700 border-t-transparent rounded-full mr-1"></span>
          Loading...
          } @else {
          Refresh Data
          }
        </button>
      </h2>

      @if (isLoadingAll()) {
      <div class="text-center p-8 text-indigo-600 font-medium">
        <span
          class="animate-spin inline-block w-6 h-6 border-4 border-indigo-600 border-t-transparent rounded-full mr-2"></span>
        Fetching all tracking records...
      </div>
      } @else if (allTrackingError()) {
      <div class="p-4 bg-red-100 rounded-lg text-red-800 border border-red-300">
        <p class="font-bold">Error loading dashboard:</p>
        <p>{{ allTrackingError() }}</p>
      </div>
      } @else if (allTrackingRecords().length === 0 && !isLoadingAll()) {
      <div class="p-4 bg-yellow-100 rounded-lg text-yellow-800 border border-yellow-300">
        No email tracking records found. Send an email first.
      </div>
      }

      @if (allTrackingRecords().length > 0) {
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Recipient
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Sent Time
              </th>
              <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                Opens
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Last Open
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Location
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Tracking ID (Click to Check)
              </th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            @for (record of allTrackingRecords(); track record.trackingId) {
            <tr [ngClass]="{'bg-indigo-50': record.openCount > 0}">
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                {{ record.recipientEmail }}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                {{ trackingService.formatTimestamp(record.sentTimestamp) }}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-bold"
                [ngClass]="{'text-teal-600': record.openCount > 0, 'text-gray-500': record.openCount === 0}">
                {{ record.openCount }}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                {{ trackingService.formatTimestamp(record.lastOpenTimestamp) || 'N/A' }}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                {{ record.clientCity || 'N/A' }} ({{ record.clientCountry || 'N/A' }})
              </td>
              <td
                class="px-6 py-4 whitespace-nowrap text-sm font-mono text-xs cursor-pointer text-indigo-600 hover:underline"
                (click)="statusForm.trackingId = record.trackingId; checkStatus();">
                {{ record.trackingId }}
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>
      }
    </div>

  </div>
</div>
<script>
  function scrollToTop() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
</script>